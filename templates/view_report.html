{% extends "base.html" %}

{% block content %}

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Preparing Download...</div>
</div>

<style>
    /* --- Fixes & Enhancements --- */
    
    /* 1. Make the main page container from base.html transparent */
    .container {
        max-width: 1400px !important; /* Ensure it stays wide for reports */
        background: transparent !important;
        box-shadow: none !important;
        backdrop-filter: none !important;
        border: none !important;
        padding-top: 20px !important;
        padding-bottom: 20px !important;
    }

    /* 2. Fix the blurry H1 text from base.html AND on this page */
    .container > h1, .header-title {
        background: none !important;
        -webkit-text-fill-color: #ffffff !important;
        color: #ffffff !important;
        animation: none !important;
        filter: none !important;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5) !important;
    }
    
    .container > h1 {
        margin-bottom: 30px;
    }

    /* 3. Loading Overlay Styles */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 5, 25, 0.85);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.4s ease;
    }

    .loading-overlay.show {
        display: flex;
        opacity: 1;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 25px;
    }

    .loading-text {
        color: #ffffff;
        font-size: 1.5rem;
        font-weight: 500;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }


    /* --- Original Page Styles (with enhancements) --- */

    .report-container {
        padding: 0;
        animation: fadeIn 0.8s ease-out;
    }

    /* Cards and content now have a semi-transparent background to float over the animation */
    .header-section, .action-bar, .workflow-card, .report-viewer-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .header-section {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
        color: white;
        box-shadow: 0 10px 30px rgba(0,0,0, 0.2);
        animation: slideInDown 0.6s ease-out;
    }

    .header-title {
        font-size: 2.2rem;
        font-weight: 700;
        margin: 0 0 8px 0;
    }

    .header-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 300;
        margin: 0;
    }

    .action-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        animation: slideInUp 0.6s ease-out 0.1s both;
    }

    .action-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        text-decoration: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .action-btn:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    }
    
    .action-btn.primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
    }

    .action-btn.primary:hover {
        color: white;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .action-btn.download-html {
        background: linear-gradient(45deg, #10b981, #059669);
        color: white;
        border: none;
    }

    .action-btn.download-html:hover {
        color: white;
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }
    
    .action-btn.download-pdf {
        background: linear-gradient(45deg, #ef4444, #f97316); /* Red -> Orange */
        color: white;
        border: none;
    }

    .action-btn.download-pdf:hover {
        color: white;
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }
    
    .spacer {
        flex: 1;
    }

    .section-label {
        font-weight: 600;
        color: rgba(255,255,255,0.8);
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .workflow-card {
        padding: 30px;
        margin-bottom: 30px;
        border-radius: 16px;
    }

    .card-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: #f9fafb;
        margin: 0 0 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .workflow-log {
        background: rgba(0,0,0,0.2);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        padding: 20px;
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 0.85rem;
        line-height: 1.6;
        max-height: 400px;
        color: #e5e7eb;
        position: relative;
    }
    
    .report-viewer-card {
        padding: 0;
        border-radius: 16px;
        overflow: hidden;
    }

    .report-tabs {
        display: flex;
        background: rgba(0,0,0,0.1);
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding: 0 30px;
    }

    .report-tab {
        padding: 15px 20px;
        background: none;
        border: none;
        color: rgba(255,255,255,0.7);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
    }

    .report-tab.active {
        color: #ffffff;
        border-bottom-color: #667eea;
        background: rgba(102, 126, 234, 0.15);
    }

    .report-tab:hover:not(.active) {
        color: #ffffff;
        background: rgba(255,255,255,0.1);
    }
    
    .report-iframe {
        width: 100%;
        height: 80vh;
        border: none;
        border-radius: 12px;
    }
</style>

<div class="report-container">
    <div class="header-section">
        <h1 class="header-title">EDA Report Dashboard</h1>
        <p class="header-subtitle">Comprehensive data analysis and insights</p>
    </div>

    <div class="action-bar">
        <a href="{{ url_for('index') }}" class="action-btn primary">
            <span>‚¨ÖÔ∏è</span> Upload Another Dataset
        </a>
        
        {% if raw_report %}
            <a href="{{ url_for('download_report', filename=raw_report) }}" class="action-btn download-html">
                <span>üì•</span> Download Raw HTML
            </a>
            {% if raw_pdf %}
                <a href="{{ url_for('download_report', filename=raw_pdf) }}" class="action-btn download-pdf">
                    <span>üìÑ</span> Download Raw PDF
                </a>
            {% endif %}
        {% endif %}
        
        {% if cleaned_report %}
            <a href="{{ url_for('download_report', filename=cleaned_report) }}" class="action-btn download-html">
                <span>üì•</span> Download Cleaned HTML
            </a>
            {% if clean_pdf %}
                <a href="{{ url_for('download_report', filename=clean_pdf) }}" class="action-btn download-pdf">
                    <span>üìÑ</span> Download Cleaned PDF
                </a>
            {% endif %}
        {% endif %}
        
        <div class="spacer"></div>
        <span class="section-label">Analysis Complete</span>
    </div>

    <div class="report-viewer-card">
        {% if cleaned_report or raw_report %}
            <div class="report-tabs">
                {% if cleaned_report %}
                    <button class="report-tab active" onclick="switchReport('cleaned')">
                        <span>‚ú®</span> Cleaned Report
                    </button>
                {% endif %}
                {% if raw_report %}
                    <button class="report-tab {% if not cleaned_report %}active{% endif %}" onclick="switchReport('raw')">
                        <span>üìä</span> Raw Report
                    </button>
                {% endif %}
            </div>
        {% endif %}
        
        <div class="report-iframe-container" style="padding: 20px;">
            {% if cleaned_report %}
                <iframe id="cleanedFrame" src="{{ url_for('serve_report', filename=cleaned_report) }}" class="report-iframe"></iframe>
            {% endif %}
            {% if raw_report %}
                <iframe id="rawFrame" src="{{ url_for('serve_report', filename=raw_report) }}" class="report-iframe" {% if cleaned_report %}style="display: none;"{% endif %}></iframe>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function switchReport(type) {
        const tabs = document.querySelectorAll('.report-tab');
        const cleanedFrame = document.getElementById('cleanedFrame');
        const rawFrame = document.getElementById('rawFrame');
        
        tabs.forEach(tab => tab.classList.remove('active'));
        
        if (type === 'cleaned' && cleanedFrame) {
            cleanedFrame.style.display = 'block';
            if (rawFrame) rawFrame.style.display = 'none';
            document.querySelector('[onclick="switchReport(\'cleaned\')"]').classList.add('active');
            
        } else if (type === 'raw' && rawFrame) {
            rawFrame.style.display = 'block';
            if (cleanedFrame) cleanedFrame.style.display = 'none';
            document.querySelector('[onclick="switchReport(\'raw\')"]').classList.add('active');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const downloadButtons = document.querySelectorAll('.action-btn.download-html, .action-btn.download-pdf');
        const loadingOverlay = document.getElementById('loadingOverlay');

        downloadButtons.forEach(button => {
            button.addEventListener('click', () => {
                loadingOverlay.classList.add('show');
                
                // Hide the overlay after 3 seconds as we can't detect when the download is finished.
                setTimeout(() => {
                    loadingOverlay.classList.remove('show');
                }, 3000);
            });
        });
    });
</script>

{% endblock %}